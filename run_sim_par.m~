clear;
start1=tic;
scPaths = {'sc_1_BSTS_nn1.hdf5',...
'sc_2_CAC_nn1.hdf5',...
'sc_3_CMF_nn1.hdf5',...
'sc_4_CUN_nn1.hdf5',...
'sc_5_ENT_nn1.hdf5',...
'sc_6_FUS_nn1.hdf5',...
'sc_7_IP_nn1.hdf5',...
'sc_8_IT_nn1.hdf5',...
'sc_9_ISTH_nn1.hdf5',...
'sc_10_LOCC_nn1.hdf5',...
'sc_11_LOF_nn1.hdf5',...
'sc_12_LING_nn1.hdf5',...
'sc_13_MOF_nn1.hdf5',...
'sc_14_MT_nn1.hdf5',...
'sc_15_PARH_nn1.hdf5',...
'sc_16_PARC_nn1.hdf5',...
'sc_17_POPE_nn1.hdf5',...
'sc_18_PORB_nn1.hdf5',...
'sc_19_PTRI_nn1.hdf5',...
'sc_20_PCAL_nn1.hdf5',...
'sc_21_PCNT_nn1.hdf5',...
'sc_22_PC_nn1.hdf5',...
'sc_23_PREC_nn1.hdf5',...
'sc_24_PCUN_nn1.hdf5',...
'sc_25_RAC_nn1.hdf5',...
'sc_26_RMF_nn1.hdf5',...
'sc_27_SF_nn1.hdf5',...
'sc_28_SP_nn1.hdf5',...
'sc_29_ST_nn1.hdf5',...
'sc_30_SMAR_nn1.hdf5',...
'sc_31_FP_nn1.hdf5',...
'sc_32_TP_nn1.hdf5',...
'sc_33_TT_nn1.hdf5',...
'sc_34_INS_nn1.hdf5',...
'sc_35_BSTS_nn1.hdf5',...
'sc_36_CAC_nn1.hdf5',...
'sc_37_CMF_nn1.hdf5',...
'sc_38_CUN_nn1.hdf5',...
'sc_39_ENT_nn1.hdf5',...
'sc_40_FUS_nn1.hdf5',...
'sc_41_IP_nn1.hdf5',...
'sc_42_IT_nn1.hdf5',...
'sc_43_ISTH_nn1.hdf5',...
'sc_44_LOCC_nn1.hdf5',...
'sc_45_LOF_nn1.hdf5',...
'sc_46_LING_nn1.hdf5',...
'sc_47_MOF_nn1.hdf5',...
'sc_48_MT_nn1.hdf5',...
'sc_49_PARH_nn1.hdf5',...
'sc_50_PARC_nn1.hdf5',...
'sc_51_POPE_nn1.hdf5',...
'sc_52_PORB_nn1.hdf5',...
'sc_53_PTRI_nn1.hdf5',...
'sc_54_PCAL_nn1.hdf5',...
'sc_55_PCNT_nn1.hdf5',...
'sc_56_PC_nn1.hdf5',...
'sc_57_PREC_nn1.hdf5',...
'sc_58_PCUN_nn1.hdf5',...
'sc_59_RAC_nn1.hdf5',...
'sc_60_RMF_nn1.hdf5',...
'sc_61_SF_nn1.hdf5',...
'sc_62_SP_nn1.hdf5',...
'sc_63_ST_nn1.hdf5',...
'sc_64_SMAR_nn1.hdf5',...
'sc_65_FP_nn1.hdf5',...
'sc_66_TP_nn1.hdf5',...
'sc_67_TT_nn1.hdf5',...
'sc_68_INS_nn1.hdf5'};

fcPaths = {'../../data/connectivity_68/SC_FC_all/EU_20120803.hdf5'};

resultsPaths = {
};

scName = '/C';
disp('Simulation Parameters:');
t = load('../../results/68/optimalG_EU_20120803_fic_dt1_sigma0.001_8mins_EI.mat','wEI');
ficWeights = t.wEI{24};
% ficWeights = h5read('../../results/68/simhc_998_G1.7_dt1_sigma0.001_8mins.hdf5','/wEI');
clear t;
nAreas = 68
nItersPerSim = 1
simTime = 8*60*1000
fic = false
ffi = false
dt = 1
G = 0.6
noiseAmp = 0.001
% fc_healthy = h5read(fcPaths{1},'/CC');
t = load('../../results/68/optimalG_EU_20120803_fic_dt1_sigma0.001_8mins_EI.mat','fcs');
fc_healthy = t.fcs{24};
clear t;
% lesionAreas = 1:68;
csvPath = '../../results/68/EU/run_all_G0.6_sigma0.001_ficprior_nn1_8mins.csv'
fid = fopen(csvPath,'w');
fprintf(fid,sprintf('%s',['SC_Name','\t']));
fprintf(fid,sprintf('%s',['avgCorr','\t']));
fprintf(fid,sprintf('%s',['maxCorr','\t']));
fprintf(fid,sprintf('%s',['avgFCCorr','\n']));

% disp(strcat(['nAreas: ',num2str(nAreas)]));
% disp(strcat(['nItersPerSim: ',num2str(nItersPerSim)]));
% disp(strcat(['simTime: ',num2str(simTime)]));
% disp(strcat(['fic: ',num2str(fic)]));
% disp(strcat(['fic: ',num2str(ffi)]));
% disp(strcat(['dt: ',num2str(dt)]));
% disp(strcat(['G: ',num2str(G)]));
% p = parpool(6);
for i = 1:length(scPaths)
    start2=tic;
    maxFCCorr = 0;
    scPath = ['../../data/connectivity_68/SC_FC_all/lesioned/EU/' scPaths{i}];
    resultsPath = ['../../results/68/EU/' resultsPaths{i}];
    rmCmd = strcat(['rm ',resultsPath]);
    if(~system(strcat(['test -e ',resultsPath])))
        system(rmCmd);
    end
    fcs = cell(nItersPerSim);
    frNs = cell(nItersPerSim);
    fcCorrs = zeros(1,nItersPerSim);
    lesionAreas = h5read(['../../data/connectivity_68/SC_FC_all/lesioned/EU/' scPaths{i}],'/Neighbours');
    for j = 1:nItersPerSim
        [fcs{j},frNs{j},curr,wEI] = DMF_lesioned(scPath,scName,fic,ffi,simTime,dt,G,noiseAmp,lesionAreas,ficWeights,true);
        fcCorrs(j) = find_corr_lesioned(fcs{j},fc_healthy,lesionAreas);
    end
    maxFCIdx = 0;
    for k = 1:nItersPerSim
        if (k == 1)
           avgFC = fcs{k};
        else
           avgFC = avgFC + fcs{k};
        end
        if(maxFCCorr < fcCorrs(k))
            maxFCCorr = fcCorrs(k);
            maxFCIdx = k;
        end
    end
    avgFC = avgFC ./ nItersPerSim;
    avgCorr = mean(fcCorrs);
    avgFCCorr = find_corr(avgFC,fc_healthy);
    frNmax = frNs{maxFCIdx};
    h5create(resultsPath,'/CC',[nAreas nAreas]);
    h5write(resultsPath,'/CC',fcs{maxFCIdx});
    h5create(resultsPath,'/avgCC',[nAreas nAreas]);
    h5write(resultsPath,'/avgCC',avgFC);
    h5create(resultsPath,'/frNmax',nAreas);
    h5write(resultsPath,'/frNmax',frNmax);
    h5create(resultsPath,'/wEI',nAreas);
    h5write(resultsPath,'/wEI',wEI);

    disp(strcat(['Avg. correlatoin for ',scPath,': ',num2str(avgCorr)]));
    disp(strcat(['Max. FC correlatoin for ',scPath,': ',num2str(maxFCCorr)]));
    disp(strcat(['Avg. FC correlatoin for ',scPath,': ',num2str(avgFCCorr)]));
    disp(strcat(['Saved FC of ',scPath,' as: ',resultsPath]));
    fprintf(fid,sprintf('%s\t',scPath));
    fprintf(fid,sprintf('%.4f\t',[avgCorr maxFCCorr avgFCCorr]));
    fprintf(fid,sprintf('%s','\n'));
    clear fcs frNs fcCorrs;
    toc(start2);
end
fclose(fid);
% p.delete;
% clear p;
toc(start1);
